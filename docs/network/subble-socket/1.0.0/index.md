# SubbleSocket 
> Version 1.0.0

## Overview

The SubbleSocket protocol enables a two-way communication between a ISubbleHost instance and a third party client.
The security model is out of scope of this document, being that the implementor responsibility.
This protocol aims at allowing external applications to consume and produce events in a Subble instance.

Apart of the initial handshake, when a client do a request it is not guarantee that the next message from the server will be related. If the clients wants to track the request it should append data, that data will also be append by server in the related request

The protocol can be divided in two parts:
    - Handshake: the clients connects and send list of required events
    - Event Consume/Produce: the client listens for events and / or produce events

**Encoding**

Every text used in this format must be in UTF-8

**Case sensitive**

Every text is case sensitive except when explicitly said in this document.

## Serialization

the server must support [MessagePack](https://msgpack.org/) and should also support [JSON](http://json.org/). The implementor is free to support custom serializers, but must not use the values between 0 (zero) and 50 (fifty) because they are reserved for future requirements. the current serializers map is as follow:

- 0: MessagePack
- 1: JSON
- 2 - 50: Reserved
- 51-255: Implementor defined

for the purpose of readability this document will the JSON format in examples.

## Handshake

When a Clients connects it must send the handshake initial request, the server will not continue with any communication until the initial handshake is completed. A appropriate response is trigger by the server

## Handshake Request

The initial client request is composed by:

    1 byte : Request code, 1
    1 byte : Protocol Major Version
    1 byte : Protocol Minor Version
    1 byte : Protocol Patch Version
    
    4 + N byte : Client ID
    1 + N byte : Value separator
    4 + N byte : Subscribe list
    4 + N byte : Produce list
    N byte : Request data

**Request code**
The request code, to start the handshake the request is always 1

**Protocol Major, Minor and Patch Version**

The first three bytes are the version used by the client, if the server don't support the specified version a error response is trigger,
see [Handshake Response](#handshake-response) for more details.

**Client ID**

A id that identify the client, see [Client ID section](#client-id) for details

**Value separator**

Defines the value that separates the subscribe and produce list.
The length is 1 + n bytes, being the first byte the value that set the length of N

**Subscribe list**

If the client want to receive events of a certain type it must pass the names to subscribe.
The names should be in UTF-8 format and be separated by the value defined in 'Value separator'.

**Produce list**

If the client want to generate new events it must pass the event type name.
The names should be in UTF-8 format and be separated by the value defined in 'Value separator'.

**Request data**

Custom message that the client can append to the request

## Handshake Response
After the client sends the Handshake request the server responds, the first byte is a [Response code](#handshake-codes), and the next four bytes are the length of UTF-8 message. The response message is only present when required.
We can visualize the response as:

    1 byte: Response code, ()
    4 + N bytes: Response message
    N bytes: Request data

## Events
Every time a event occurs, that the client has subscribe during handshake, a new request is made by the server
the request will have the following format

    1 byte: Event request code
    1 byte: Serialization format
    8 byte: Date time
    4 + N byte: Event type name
    4 + N byte: Event GUID
    4 + N byte: Source name
    4 + N byte: Payload
    N byte: Request data

**Event request code**

the event status, see [Request codes](#events-codes) for details.

**Serialization format**

The serialization format used on payload, see [Serialization](#serialization).

**Date time**

The date and time that the event occur, it is in unix EPOCH time format.

**Event type name**
The name that classifies the event

**Event GUID**
Event unique ID generated by the server

**Source name**
The name of the plugin/client that generate the event

**Payload**
event data

**Request data**
If the event was created by this client and it contains 

### Produce events
The client is able to produce events, at every request to create an event the server responds with the event data

To create an event the client must do a request with the following structure:

    1 byte: request code, 27
    4 + N byte: Client ID
    1 byte: Serialization format
    4 + N byte: Event type name
    4 + N byte: Payload
    N byte: Request Data

**Request code**

The code of the request, 27 to create event, see [Request codes](#events-codes) for more details

**Client ID**

The client ID, see [Client ID section](#client-id) for details

**Serialization format**

The serialization format used on payload, see [Serialization](#serialization).

**Event type name**
The name that classifies the event

**Payload**
Event payload

**Request data**
Data to be return by the server

## Error Handling

Every time the client does a request that generates a error, the server should create a new request to that client with the error details
Request details:

    1 byte: Request Code
    4 + N bytes: Error Message
    N bytes: request data

## Client ID
A UTF-8 text that will identify the client, this value should be generated by the server.
The length is 4 + n bytes, being the first 4 byte the value that set the length of N
If the length is zero, the server may reject the handshake or generate a new ID that will be returned on the response
It is not possible to change value after the Handshake.
This value should be present in every client requests

**Client ID Generation**
The server if free to generate new client id as he sees fit as long as no client id is repeat

## Subble Codes
The code list can be divided in 3 major groups:

- 0 -> 25 : Handshake codes
- 26 -> 100: Events codes
- 101 -> 255: Other codes

### Handshake codes

- 1: Request Access:
The code sent in the request to start the handshake

- 2: **OK**: 
The handshake is completed and the server is ok to receive new request

- 3: **OK** - New User ID created:
The handshake is completed and the server has successfully created a new client ID, check the message for the client ID

- 10: **NOT OK** - IP not allowed: 
Server is actively denying the client IP, check a possible whitelist or blacklist

- 11: **NOT OK** - New clients not allowed: 
The Client ID was not defined and the server has the generation of new client ID disabled

- 12: **NOT OK** - Invalid client ID:
The Client was defined, but the server don't recognize it

- 25: **NOT OK** - Unknown handshake Error: 
Server refused the connection for unknown reasons, check response message for details

### Events Codes
- 26: **Server Event**: 
Event created in server side, events created by other clients will also have this code

- 27: **Client Event**: 
Event created by client

- 52: **Unknown Server Error**: 
Event was not created by server

- 51: **Event not declared**: 
Event name was not defined during handshake