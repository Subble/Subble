# SubbleSocket 
> Version 1.0.0

## Overview

The SubbleSocket protocol enables a two-way communication between a ISubbleHost instance and a third party client.
The security model is out of scope of this document, being that the implementor responsibility.
This protocol aims at allowing external applications to consume and produce events in a Subble instance.

The protocol can be divided in two parts:
    - Handshake: the clients connects and send list of required events
    - Event Consume/Produce: the client listens for events and / or produce events

**Encoding**

Every text used in this format must be in UTF-8

**Case sensitive**

Every text is case sensitive except when explicity said in this document.

## Serialization

the server must support [MessagePack](https://msgpack.org/) and should also support [JSON](http://json.org/). The implementor is free to support custom serializers, but must not use the values between 0 (zero) and 50 (fifty) because they are reserved for future requirements. the current serializers map is as follow:

- 0: MessagePack
- 1: JSON
- 2 - 50: Reserved
- 51-255: Implementor defined

for the purpose of readability this document will the JSON format in examples.

## Handshake

When a Clients connects it must send the handshake initial request, the server will not continue with any comunication until the initial handshake is completed. A appropriate response is trigger by the server

## Handshake Request

The initial client request is composed by:

    1 byte : Protocol Major Version
    1 byte : Protocol Minor Version
    1 byte : Protocol Patch Version
    1 byte : Serialization format
    
    1 + N byte : Value separator
    4 + N byte : Client ID
    4 + N byte : Subscribe list
    4 + N byte : Produce list

**Protocol Major, Minor and Patch Version**
The first three bytes are the version used by the client, if the server don't support the specified version a error response is trigger,
see [Handshake Response](#handshake-response) for more details.

**Serialization format**
1 byte number to set the serialization format to use, see [Serialization section](#serialization) for more details.

**Value separator**
Defines the value that separates the subscribe and produce list.
The length is 1 + n bytes, being the first byte the value that set the length of N

**Client ID**
A UTF-8 text that will identify the client, this value should be generated by the server.
The length is 4 + n bytes, being the first 4 byte the value that set the length of N
If the length is zero, the server may reject the handshake or generate a new ID that will be returned on the response
It is not possible to change value after Handshake being the alternative, a bew connection.

**Subscribe list**

## Handshake Response
After the client sends the Handshake request the server responds. The response is composed by:

    4 byte : Response length
    N byte : Response

The response has the following fields:

1. ClientGUID: Client identification
2. Accept: defines the handshake result
3. ErrorCode: code of error

**1) ClientGUID**

If does not defined a GUID when creating the request, this will contain the server generated id.
The client should store this value and use it in future requests to allow for data persistance.

**2) Accept**

This field defines the handshake result. if false the handshake was rejected, the client should see ErrorCode for details

**3) ErrorCode**

If an error occur this field will have an number, see [Handshake Error Codes](#handshake-error-codes) for details.

## Client ID


## Handshake Error Codes

- 0: Unknown Error

Server refused the connection for unknown reasons, check log for details

- 1: IP not allowed

Server is actively denying the client IP, check a possible whitelist or blacklist

- 2: New Clients not allowed

The client is new and the server actively refuses to register new clients

- 3: Invalid server secret

The secret sent by the client does not match the server one
